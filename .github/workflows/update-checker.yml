name: Check Upstream Release

on:
  schedule:
    - cron: '0 * * * *'  # 每小时检查一次
  workflow_dispatch:      # 允许手动触发

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest release from upstream
        id: upstream
        run: |
          UPSTREAM_REPO="owner/upstream-repo"
          LATEST_TAG=$(curl -s https://api.github.com/repos/$UPSTREAM_REPO/releases/latest | jq -r .tag_name)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Compare with last known version
        id: compare
        run: |
          LAST_TAG_FILE=".last_tag"
          if [ -f $LAST_TAG_FILE ]; then
            LAST_TAG=$(cat $LAST_TAG_FILE)
          else
            LAST_TAG="none"
          fi
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

          if [ "$LAST_TAG" != "${{ steps.upstream.outputs.latest_tag }}" ]; then
            echo "new_release=true" >> $GITHUB_OUTPUT
          else
            echo "new_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger workflow if new release
        if: steps.compare.outputs.new_release == 'true'
        run: |
          echo "New release detected: ${{ steps.upstream.outputs.latest_tag }}"
          # 更新记录
          echo "${{ steps.upstream.outputs.latest_tag }}" > .last_tag

          # 提交更新记录（或仅触发其他 workflow）
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .last_tag
          git commit -m "Update upstream version to ${{ steps.upstream.outputs.latest_tag }}"
          git push

          # 可选：触发另一个 workflow
          gh workflow run .github/workflows/name: Check Upstream Release

on:
  schedule:
    - cron: '0 * * * *'  # 每小时检查一次
  workflow_dispatch:      # 允许手动触发

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest release from upstream
        id: upstream
        run: |
          UPSTREAM_REPO="vernesong/OpenClash"
          LATEST_TAG=$(curl -s https://api.github.com/repos/$UPSTREAM_REPO/releases/latest | jq -r .tag_name)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Compare with last known version
        id: compare
        run: |
          LAST_TAG_FILE=".last_tag"
          if [ -f $LAST_TAG_FILE ]; then
            LAST_TAG=$(cat $LAST_TAG_FILE)
          else
            LAST_TAG="none"
          fi
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

          if [ "$LAST_TAG" != "${{ steps.upstream.outputs.latest_tag }}" ]; then
            echo "new_release=true" >> $GITHUB_OUTPUT
          else
            echo "new_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger workflow if new release
        if: steps.compare.outputs.new_release == 'true'
        run: |
          echo "New release detected: ${{ steps.upstream.outputs.latest_tag }}"
          # 更新记录
          # echo "${{ steps.upstream.outputs.latest_tag }}" > .last_tag

          # 提交更新记录（或仅触发其他 workflow）
          # git config user.name github-actions
          # git config user.email github-actions@github.com
          # git add .last_tag
          # git commit -m "Update upstream version to ${{ steps.upstream.outputs.latest_tag }}"
          # git push

          # 可选：触发另一个 workflow
          gh workflow run build-rax3000m-imoutowrt.yml

